<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clínica Médica | Administración de Médicos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://kit.fontawesome.com/2a7e1c6c6b.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="styles.css"> <style>
        .container-admin { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .table-medicos img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; }
    </style>
</head>
<body>
    <div class="container-admin mt-5">
        <h1 class="text-center mb-4">Panel de Administración de Médicos</h1>
        <hr>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fs-4 mb-0">Listado de Profesionales</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#medicoModal" 
                    onclick="cargarFormulario('crear')">
                <i class="fas fa-plus"></i> Crear Nuevo Médico
            </button>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-medicos">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Foto</th>
                        <th>Nombre</th>
                        <th>Especialidad</th>
                        <th>Matrícula</th>
                        <th>Precio</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="listaMedicosBody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="modal fade" id="medicoModal" tabindex="-1" aria-labelledby="medicoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="medicoModalLabel">Administrar Médico</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="medicoForm">
                        <input type="hidden" id="medicoId">
                        
                        <div class="row g-3">
                            <div class="col-md-6 mb-3">
                                <label for="nombre" class="form-label">Nombre y Apellido</label>
                                <input type="text" class="form-control" id="nombre" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="especialidad" class="form-label">Especialidad</label>
                                <input type="text" class="form-control" id="especialidad" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="matricula" class="form-label">Matrícula (MN)</label>
                                <input type="text" class="form-control" id="matricula" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="precio" class="form-label">Precio ($)</label>
                                <input type="number" class="form-control" id="precio" required min="0">
                            </div>
                            <div class="col-12 mb-3">
                                <label for="obras_sociales" class="form-label">Obras Sociales</label>
                                <input type="text" class="form-control" id="obras_sociales">
                                <div class="form-text">Separar por comas (ej: OSDE, Swiss Medical)</div>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="descripcion_adicional" class="form-label">Descripción Detallada</label>
                                <textarea class="form-control" id="descripcion_adicional" rows="3"></textarea>
                            </div>
                            <div class="col-12 mb-3">
                                <label for="imagen_src" class="form-label">URL Imagen de Perfil</label>
                                <input type="url" class="form-control" id="imagen_src">
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end pt-3 border-top">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-success" id="btnGuardar"><i class="fas fa-save"></i> Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { getMedicos, crearMedico, modificarMedico, eliminarMedico, getMedicoById } from './adminScript.js';

        document.addEventListener('DOMContentLoaded', () => {
            renderizarTabla();
        });

        // 1. Listar: Renderiza la tabla de médicos
        const renderizarTabla = () => {
            const tbody = document.getElementById('listaMedicosBody');
            tbody.innerHTML = '';
            
            const medicos = getMedicos();
            
            medicos.forEach(medico => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${medico.id}</td>
                    <td><img src="${medico.imagen_src}" alt="${medico.nombre}" class="img-fluid"></td>
                    <td>${medico.nombre}</td>
                    <td>${medico.especialidad}</td>
                    <td>${medico.matricula}</td>
                    <td>$${medico.precio.toLocaleString('es-AR')}</td>
                    <td>
                        <button class="btn btn-info btn-sm me-1" onclick="cargarFormulario('visualizar', ${medico.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm me-1" onclick="cargarFormulario('modificar', ${medico.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="confirmarEliminar(${medico.id}, '${medico.nombre}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        // Rellena el formulario/modal para Crear, Visualizar o Modificar
        window.cargarFormulario = (accion, id = null) => {
            const form = document.getElementById('medicoForm');
            const modalTitle = document.getElementById('medicoModalLabel');
            const btnGuardar = document.getElementById('btnGuardar');
            
            form.reset();
            let medico = {};
            let soloLectura = false;
            
            if (id) {
                medico = getMedicoById(id);
                // Si el médico no existe, no continuar
                if (!medico) return; 
            }

            // Configurar modal y campos
            document.getElementById('medicoId').value = id || '';
            
            if (accion === 'crear') {
                modalTitle.textContent = 'Crear Nuevo Médico';
                btnGuardar.textContent = 'Crear Médico';
                btnGuardar.classList.remove('d-none');
            } else if (accion === 'modificar') {
                modalTitle.textContent = 'Modificar Médico: ' + medico.nombre;
                btnGuardar.textContent = 'Guardar Cambios';
                btnGuardar.classList.remove('d-none');
            } else if (accion === 'visualizar') {
                modalTitle.textContent = 'Detalle de Médico: ' + medico.nombre;
                soloLectura = true;
                btnGuardar.classList.add('d-none'); // Ocultar botón de guardar
            }

            // Llenar campos si es Modificar o Visualizar
            if (id && medico) {
                document.getElementById('nombre').value = medico.nombre || '';
                document.getElementById('especialidad').value = medico.especialidad || '';
                document.getElementById('matricula').value = medico.matricula || '';
                document.getElementById('precio').value = medico.precio || 0;
                document.getElementById('obras_sociales').value = medico.obras_sociales || '';
                document.getElementById('descripcion_adicional').value = medico.descripcion_adicional || '';
                document.getElementById('imagen_src').value = medico.imagen_src || '';
            }

            // Habilitar/deshabilitar campos (para Visualizar/Leer)
            Array.from(form.elements).forEach(element => {
                if (element.id !== 'medicoId') {
                    element.disabled = soloLectura;
                }
            });
            
            // Mostrar modal (Se asume que la función ya está definida en el onclick)
        };

        // 3. Crear y 4. Modificar: Manejar el envío del formulario
        document.getElementById('medicoForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('medicoId').value ? parseInt(document.getElementById('medicoId').value) : null;
            
            const datos = {
                nombre: document.getElementById('nombre').value,
                especialidad: document.getElementById('especialidad').value,
                matricula: document.getElementById('matricula').value,
                precio: document.getElementById('precio').value,
                obras_sociales: document.getElementById('obras_sociales').value,
                descripcion_adicional: document.getElementById('descripcion_adicional').value,
                imagen_src: document.getElementById('imagen_src').value,
            };
            
            if (id) {
                modificarMedico(id, datos); 
                alert(`Médico ${datos.nombre} modificado correctamente.`);
            } else {
                crearMedico(datos); 
                alert(`Médico ${datos.nombre} creado correctamente.`);
            }
            
            // Cerrar modal y actualizar la tabla
            const modalElement = document.getElementById('medicoModal');
            const modalInstance = bootstrap.Modal.getInstance(modalElement);
            if (modalInstance) {
                modalInstance.hide();
            }
            renderizarTabla();
        });

        // 5. Eliminar: Manejar la eliminación
        window.confirmarEliminar = (id, nombre) => {
            if (confirm(`¿Está seguro de eliminar al médico ${nombre} (ID: ${id})? Esta acción es irreversible.`)) {
                if (eliminarMedico(id)) {
                    alert(`Médico ${nombre} eliminado correctamente.`);
                    renderizarTabla();
                } else {
                    alert('Error al intentar eliminar el médico.');
                }
            }
        };
    </script>
</body>
</html>